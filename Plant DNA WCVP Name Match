WITH pdna AS 
       (SELECT ds.pID, ds.iTaxonName, w.powo_id, w.taxon_status, w.taxon_name, ds.TemporaryName, 
                ds.Genus, ds.Species, ds.InfraSpecific, ds.InfraspecificRank, 
                ROW_NUMBER() over (partition by ds.pID order by ds.pID, w.taxon_status) as rn, 
                COUNT(pID) OVER (PARTITION BY pID ORDER BY pID) AS ct
         FROM [dbo].[AAApDNA_3252_1806] as ds
              LEFT JOIN dbo.wcvp_names as w ON w.taxon_name COLLATE SQL_Latin1_General_CP1_CI_AS = ds.iTaxonName
         ), 

okPowo AS ( SELECT pID, TemporaryName, iTaxonName,powo_id, taxon_status, taxon_name, 
                  ROW_NUMBER() OVER (PARTITION BY pID ORDER BY pID) AS rn
            FROM pdna
            WHERE pdna.powo_id IS NOT NULL
           ),

nilPowo AS (SELECT pID, TemporaryName, iTaxonName, pdna.Genus, pdna.Species, InfraSpecific,
                  wcvp_names.taxon_name, wcvp_names.powo_id, wcvp_names.taxon_status, 
                   ROW_NUMBER() OVER (PARTITION BY pID ORDER BY pID) AS rn
            FROM pdna
                LEFT JOIN wcvp_names ON wcvp_names.taxon_name COLLATE SQL_Latin1_General_CP1_CI_AS 
                                           = CONCAT( pdna.Genus, ' ', pdna.Species)
            WHERE pdna.powo_id IS NULL --AND InfraspecificRank = ' '
       )
       
SELECT pID, TemporaryName, iTaxonName, powo_id, taxon_status, rn 
FROM okPowo
UNION
SELECT pID, TemporaryName, iTaxonName, powo_id, taxon_status, rn 
FROM nilPowo 
WHERE powo_id IS NOT NULL;

ORDER BY pID, rn
